console.log("JavaScript loaded successfully");let entries=[],messageLog=[],bibList=[],offlineQueue=[],editingIndex=null,bibSortDirection=Array(15).fill(1),messageSortDirection=Array(3).fill(1),currentSortColumn=null,currentSortDirection=1;const distances=["30K","50K","50 mile","100K","100 mile","200 mile","DNS"],serverURL="/passes_load.php";let isSubmitting=!1,showAlerts="false"!==localStorage.getItem("showAlerts");async function isOnline(){try{return(await fetch("passes_load.php?limit=500",{method:"GET",cache:"no-store"})).ok}catch(e){return!1}}async function sendHqAckToServer(e){if(e)try{const t=await fetch("hq_ack_message.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e})});if(!t.ok)return void console.error("hq_ack_message HTTP error",t.status);const n=await t.json();if(!n.success)return void console.error("hq_ack_message API error",n.error);console.log("HQ message ACK stored, id:",e)}catch(e){console.error("hq_ack_message fetch error",e)}}function startHqInboxFlash(){const e=document.getElementById("stationInbox");e&&e.classList.add("hq-inbox-new")}function stopHqInboxFlash(){const e=document.getElementById("stationInbox");e&&e.classList.remove("hq-inbox-new")}async function submitDistanceChange(e,t,n){const o={action:"distance_change",bib:parseInt(e),distance:t,previous_distance:n},a={bib:parseInt(e),status:`DNS | ${"DNS"===t?"Did Not Start":"Distance Change"} | Today | ${document.getElementById("aidStation")?.value||""} | Distance: ${t} | ${document.getElementById("operatorName")?.value.trim()||"Unknown"}`,distance:t,previous_distance:n};try{await fetch("passes_submit.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),await fetch("passes_submit.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})}catch(e){console.warn("Sync failed:",e)}}function saveFormState(){try{const e=document.getElementById("operatorName"),t=document.getElementById("sendTo"),n=document.getElementById("aidStation");e&&localStorage.setItem("operatorName",e.value||""),t&&localStorage.setItem("sendTo",t.value||""),n&&localStorage.setItem("aidStation",n.value||""),console.log("Saved form state to localStorage")}catch(e){console.error("Error saving form state:",e)}}function loadFormState(){try{const e=document.getElementById("operatorName"),t=document.getElementById("sendTo"),n=document.getElementById("aidStation");e&&(e.value=localStorage.getItem("operatorName")||""),t&&(t.value=localStorage.getItem("sendTo")||""),n&&(n.value=localStorage.getItem("aidStation")||""),console.log("Loaded form state from localStorage")}catch(e){console.error("Error loading form state:",e)}}function setCurrentTime(){try{const e=document.getElementById("time");if(!e)return void console.error("Time input not found");const t=new Date,n=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0");e.value=`${n}:${o}`,console.log("Time set to:",`${n}:${o}`)}catch(e){console.error("Error setting current time:",e)}}function updateSubject(){try{const e=document.getElementById("eventName")?.value||"Ray Miller 50-50",t=document.getElementById("aidStation")?.value||"",n=document.getElementById("messageNum")?.value||"1",o=document.getElementById("subject");if(!o)return void console.error("Subject input not found");o.value=`${e} ${t} Message #${n}`,console.log("Subject updated:",o.value)}catch(e){console.error("Error updating subject:",e)}}function incrementMessage(){try{const e=document.getElementById("messageNum");if(!e)return void console.error("Message number input not found");e.value=parseInt(e.value)+1,updateSubject(),console.log("Message number incremented to:",messageNum.value)}catch(e){console.error("Error incrementing message:",e)}}function checkSpelling(e){const t={anle:"ankle",recoded:"recorded",jogs:"jugs",medica:"medic"};for(let n in t)if(e.toLowerCase().includes(n))return`Possible typo: "${n}" (did you mean "${t[n]}")? Add anyway?`;return null}function saveData(e=!1){try{const t={entries:entries,messageLog:messageLog,bibList:bibList,offlineQueue:offlineQueue,generalComments:generalComments};localStorage.setItem("bibData",JSON.stringify(t)),e&&alert(`Data saved locally! (${entries.length} entries, ${messageLog.length} messages, ${bibList.length} bibs, ${offlineQueue.length} offline entries)`),console.log("Saving data locally:",t)}catch(e){console.error("Error saving data:",e),alert("Error saving data: "+e.message)}}function sortEntries(){entries.sort((e,t)=>{let n,o;try{n=new Date(`${e.date} ${e.time}`).getTime()}catch{n=NaN}try{o=new Date(`${t.date} ${t.time}`).getTime()}catch{o=NaN}return isNaN(n)&&isNaN(o)?0:isNaN(n)?1:isNaN(o)?-1:o-n}),console.log("Entries sorted newest first")}function clearForm(){try{document.getElementById("bibNumber").value="",document.getElementById("time").value="",document.getElementById("yesterday").checked=!1,document.getElementById("comment").value="",document.getElementById("eta").value="",document.getElementById("generalComment").value="",document.getElementById("bibInfoTable").style.display="none",setCurrentTime(),setTimeout(()=>{document.getElementById("bibNumber").focus()},100),console.log("Form cleared")}catch(e){console.error("Error clearing form:",e)}}function cancelEdit(){editingIndex=null,clearForm();const e=document.getElementById("updateButton");e&&(e.style.display="none");const t=document.getElementById("cancelEditButton");t&&(t.style.display="none");const n=document.getElementById("changeDistanceButton");n&&(n.style.display="inline-block"),console.log("Edit canceled")}async function loadData(){loadGeneralComments();const e=JSON.parse(localStorage.getItem("bibData")||"{}");bibList=e.bibList||[],entries=e.entries||[],offlineQueue=e.offlineQueue||[],console.log("Loaded offline queue length:",offlineQueue.length);try{const t=await isOnline();if(t&&offlineQueue.length>0&&await syncOfflineEntries(),!t)throw new Error("Offline - loading from localStorage");const n=await fetch("passes_load.php?limit=500");if(!n.ok)throw new Error(`Network response was not ok: ${n.status}`);const o=await n.json();if(console.log("Server response:",o),Array.isArray(o)){const e=o.filter(e=>e.status&&""!==e.status.trim());entries=e.map(t=>{const n=t.status?t.status.split(" | "):[],o=n.length;o<6&&console.warn("Incomplete status string:",t.status,"Length:",o);const a=bibList.find(e=>String(e.bib)===String(t.bib))||{},r=e.filter(e=>String(e.bib)===String(t.bib)&&e.status&&e.status.startsWith("Change Distance")).sort((e,t)=>new Date(t.timestamp)-new Date(e.timestamp))[0];let s="",i="";if(t.timestamp)try{const e=new Date(t.timestamp),n=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0"),r=String(e.getHours()).padStart(2,"0"),l=String(e.getMinutes()).padStart(2,"0");s=`${n}-${o}-${a}`,i=`${r}:${l}`}catch(e){console.warn("Bad timestamp for item",t,e)}const l=n[1]||"";!i&&/^\d{1,2}:\d{2}$/.test(l)&&(i=l);const c=n[2]||"N/A",d=l.toLowerCase().includes("distance change"),m=n[4]||"",g=d?[l,m].filter(Boolean).join(" — "):m;let u,b,f,p;return d||o<=6?(u="",b=n[o-1]||"N/A",f=t.eventName||document.getElementById("eventName")?.value||"Ray Miller 50 50 2025",p=t.message_num||"1"):(u=n[5]||"N/A",b=n[6]||"N/A",f=n[o-3]||"RayMiller-50-50",p=n[o-2]||t.message_num||"1"),{eventName:f,bib_number:t.bib||"N/A",action:n[0]||"N/A",time:i||l||"N/A",day:c,station:n[3]||"N/A",comment:g,eta:u||"N/A",operator:b||"N/A",date:s||t.date||"N/A",messageNum:p,first_name:t.first_name||a.firstName||"N/A",last_name:t.last_name||a.lastName||"N/A",age:t.age||parseInt(a.age)||"N/A",gender:t.gender||a.gender||"N/A",distance:r?r.distance:t.distance||a.distance||"N/A",previous_distance:r?r.previous_distance:t.previous_distance||a.previousDistance||"N/A"}}),sortEntries(),filterBibLog();const t=document.getElementById("entryCount");t&&(t.textContent=entries.length),saveData(!1)}else{console.error("Received non-array data:",o),alert("Error: Invalid data format from server. Loading from localStorage."),entries=e.entries||[],offlineQueue=e.offlineQueue||[],sortEntries(),filterBibLog();const t=document.getElementById("entryCount");t&&(t.textContent=entries.length),console.log("Loaded data from localStorage:",e)}}catch(e){console.error("Error in loadData:",e),console.log("loadData catch, showAlerts:",showAlerts),showAlerts&&alert("Offline or server error: "+e.message);const t=JSON.parse(localStorage.getItem("bibData")||"{}");entries=t.entries||[],offlineQueue=t.offlineQueue||[],console.log("Offline queue length on load:",offlineQueue.length),sortEntries(),filterBibLog();const n=document.getElementById("entryCount");n&&(n.textContent=entries.length),console.log("Loaded data from localStorage:",t)}}async function submitDistanceChange(e,t,n){const o={bib:e,distance:t,previous_distance:n,action:"distance_change",operator:document.getElementById("operatorName")?.value.trim()||"Unknown"};try{const e=await fetch("passes_submit.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),t=await e.json();t.success?console.log("Distance change saved to server"):console.warn("Server rejected distance change:",t.error)}catch(e){console.error("Failed to sync distance change:",e)}}function updateDistance(){const e=document.getElementById("distanceSelect");if(!e)return;const t=e.value;try{const e=document.getElementById("bibNumber").value.trim();if(!e)return void alert("No bib number entered.");const n=bibList.find(t=>String(t.bib)===String(e));if(!n)return void alert("Runner not found in bib list.");const o=n.distance||"N/A";if(o===t)return alert("Distance is already set to "+t+"."),void closeDistancePopup();n.previousDistance=o,n.distance=t;const a=new Date,r=`${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}`,s=document.getElementById("aidStation").value||"",i=document.getElementById("operatorName").value.trim()||"Unknown",l="DNS"===t?`DNS | ${r} | Today | ${s} | Did Not Start | ${i}`:`IN | ${r} | Today | ${s} | Distance changed to ${t} | ${i}`;fetch("submit_bib.1.3.3.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"distance_change",bib:parseInt(e),distance:t,previous_distance:o})}),fetch("submit_bib.1.3.3.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bib:parseInt(e),status:l,distance:t,previous_distance:o})});const c={eventName:document.getElementById("eventName").value||"Ray Miller 50 50 2025",bib_number:e,action:"DNS"===t?"DNS":"IN",time:r,day:"Today",station:s,comment:"DNS"===t?"Did Not Start":`Distance changed to ${t}`,eta:"",operator:i,date:a.toLocaleDateString("en-US",{timeZone:"America/Los_Angeles"}),messageNum:document.getElementById("messageNum").value||"1",first_name:n.firstName||"N/A",last_name:n.lastName||"N/A",distance:t,previous_distance:o};entries.unshift(c),sortEntries(),filterBibLog(),saveData(),closeDistancePopup(),clearForm()}catch(e){console.error("Error:",e)}}function updateBibInfo(){try{const e=document.getElementById("bibNumber")?.value.trim(),t=document.querySelector("#bibInfoTable tbody");if(!t)return void console.error("Bib info table body not found");t.innerHTML="";const n=document.querySelector(".bib-log-wrapper");if(n&&(n.scrollTop=0),e&&bibList.length>0){const n=bibList.find(t=>String(t.bib)===String(e));if(n){const e=document.createElement("tr");e.innerHTML=`\n                    <td>${n.bib}</td>\n                    <td>${n.firstName||"N/A"}</td>\n                    <td>${n.lastName||"N/A"}</td>\n                    <td>${n.age||"N/A"}</td>\n                    <td>${n.gender||"N/A"}</td>\n                    <td>${n.distance||"N/A"}</td>\n                    <td>${n.previousDistance||"N/A"}</td>\n                `,t.appendChild(e),document.getElementById("bibInfoTable").style.display="table",console.log("Bib info updated:",n)}else document.getElementById("bibInfoTable").style.display="none",console.log("No runner found for bib:",e)}else document.getElementById("bibInfoTable").style.display="none",console.log("Bib input empty or no bib list loaded")}catch(e){console.error("Error updating bib info:",e),alert("Error updating bib info: "+e.message)}}function importBibList(){try{if(!window.FileReader)return void alert("FileReader API not supported on this device. Try a different browser or device.");const e=document.createElement("input");e.type="file",e.accept=".csv,.xlsx",e.onchange=async function(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=async function(e){const t=e.target.result,n=XLSX.read(t,{type:"binary"}),o=n.Sheets[n.SheetNames[0]],a=XLSX.utils.sheet_to_json(o,{header:1}).slice(1);bibList=[],a.forEach((e,t)=>{if(e[0]){const n={bib:String(e[0]).trim(),firstName:e[1]?String(e[1]).trim():"",lastName:e[2]?String(e[2]).trim():"",age:e[3]?String(e[3]).trim():"",gender:e[4]?String(e[4]).trim():"",distance:e[5]?String(e[5]).trim():"N/A",previousDistance:"N/A"};bibList.push(n),console.log(`Parsed bib entry ${t+1}:`,n)}}),console.log(`Imported ${bibList.length} bibs`,bibList.slice(0,3)),alert(`Imported ${bibList.length} bibs! Changes auto-saved.`),saveData(!1),updateBibInfo(),filterBibLog()},n.readAsBinaryString(t)},e.click()}catch(e){console.error("Error importing bib list:",e),alert("Error importing bib list: "+e.message)}}function showDistancePopup(){try{const e=document.getElementById("bibNumber")?.value.trim();if(!e)return void alert("Enter a Bib Number to change distance.");if(!bibList.find(t=>String(t.bib)===String(e)))return void alert("Bib not found in imported list.");const t=document.getElementById("distancePopup");t?(t.style.display="block",document.getElementById("distanceSelect")?.focus(),console.log("Distance popup shown for bib:",e)):console.error("Distance popup not found")}catch(e){console.error("Error showing distance popup:",e),alert("Error showing distance popup: "+e.message)}}function closeDistancePopup(){try{const e=document.getElementById("distancePopup");e&&(e.style.display="none",document.getElementById("bibNumber").focus(),console.log("Distance popup closed"))}catch(e){console.error("Error closing distance popup:",e)}}function safeString(e){return(e||"").replace(/\|/g,"-")}function filterBibLog(){const e=document.getElementById("bibLogTable");if(!e)return console.error("Bib Log table not found in DOM"),void setTimeout(filterBibLog,100);let t=e.getElementsByTagName("tbody")[0];t||(console.warn("Bib Log table body not found, creating one"),t=document.createElement("tbody"),e.appendChild(t));const n=document.getElementById("logSearch")?.value.toLowerCase()||"",o=entries.filter(e=>Object.values(e).some(e=>String(e).toLowerCase().includes(n))).slice(0,100);t.innerHTML="",o.forEach(e=>{const n=t.insertRow();n.insertCell(0).textContent=e.bib_number,n.insertCell(1).textContent=e.action,n.insertCell(2).textContent=e.time,n.insertCell(3).textContent=e.day,n.insertCell(4).textContent=e.station,n.insertCell(5).textContent=e.comment,n.insertCell(6).textContent=e.eta,n.insertCell(7).textContent=e.operator,n.insertCell(8).textContent=e.date,n.insertCell(9).textContent=e.first_name,n.insertCell(10).textContent=e.last_name,n.insertCell(11).textContent=e.age,n.insertCell(12).textContent=e.gender,n.insertCell(13).textContent=e.distance,n.insertCell(14).textContent=e.previous_distance;n.insertCell(15).innerHTML='<a href="#" onclick="editEntry(\''+e.bib_number+"')\">Edit</a>"}),console.log("Bib Log filtered, rows:",o.length);const a=document.getElementById("bibLogTable");a&&(a.style.display="table",console.log("Table display set to visible"))}function sortBibTable(e){try{const t=["bib_number","action","time","day","station","comment","eta","operator","first_name","last_name","age","gender","distance","previous_distance"][e];bibSortDirection[e]*=-1,currentSortColumn=e,currentSortDirection=bibSortDirection[e];const n=[...entries];n.sort((e,n)=>{let o=e[t]||"",a=n[t]||"";if(["first_name","last_name","age","gender","distance","previous_distance"].includes(t)){const r=bibList.find(t=>String(t.bib)===String(e.bib_number))||{},s=bibList.find(e=>String(e.bib)===String(n.bib_number))||{};o=e[t]||r[t.replace("first_name","firstName").replace("last_name","lastName").replace("previous_distance","previousDistance")]||"N/A",a=n[t]||s[t.replace("first_name","firstName").replace("last_name","lastName").replace("previous_distance","previousDistance")]||"N/A"}if(["bib_number","age"].includes(t))o="N/A"===o?-1/0:parseFloat(o)||o,a="N/A"===a?-1/0:parseFloat(a)||a;else if("time"===t){if(o="N/A"===o?NaN:new Date(`1970-01-01T${o}Z`).getTime(),a="N/A"===a?NaN:new Date(`1970-01-01T${a}Z`).getTime(),isNaN(o)&&isNaN(a))return 0;if(isNaN(o))return 1;if(isNaN(a))return-1}else if("date"===t){if(o="N/A"===o?NaN:new Date(o).getTime(),a="N/A"===a?NaN:new Date(a).getTime(),isNaN(o)&&isNaN(a))return 0;if(isNaN(o))return 1;if(isNaN(a))return-1}return o===a?0:""===o||o===-1/0?1:""===a||a===-1/0?-1:currentSortDirection*(o>a?1:-1)}),entries=n,filterBibLog(),console.log("Bib table sorted by column",e,"direction:",currentSortDirection)}catch(e){console.error("Error sorting Bib table:",e),alert("Error sorting Bib table: "+e.message)}}function sortMessageLogTable(e){try{const t=["messageNum","action","timestamp"][e];messageSortDirection[e]*=-1;const n=[...messageLog];n.sort((n,o)=>{let a=n[t]||"",r=o[t]||"";return"messageNum"===t?(a=parseFloat(a)||a,r=parseFloat(r)||r):"timestamp"===t&&(a=new Date(a).getTime(),r=new Date(r).getTime()),a===r?0:messageSortDirection[e]*(a>r?1:-1)});const o=document.querySelector("#messageLogTable tbody");if(!o)return void console.error("Message Log table body not found");o.innerHTML="",n.forEach((e,t)=>{const n=document.createElement("tr");n.innerHTML=`\n                <td>${e.messageNum}</td>\n                <td>${e.action}</td>\n                <td>${e.timestamp}</td>\n                <td><button class="edit-button" onclick="showMessageDetails(${t})">Show Entries</button></td>\n            `,o.appendChild(n)}),console.log("Message Log table sorted by column",e,"direction:",messageSortDirection[e])}catch(e){console.error("Error sorting Message Log table:",e),alert("Error sorting Message Log table: "+e.message)}}function editEntry(e){try{const t=entries.find(t=>t.bib_number===e);if(!t)return void console.error("Entry not found for bib:",e);editingIndex=entries.indexOf(t),document.getElementById("bibNumber").value=t.bib_number,document.getElementById("time").value=t.time,document.getElementById("yesterday").checked="Yesterday"===t.day,document.getElementById("aidStation").value=t.station,document.getElementById("comment").value=t.comment,document.getElementById("eta").value=t.eta,document.getElementById("operatorName").value=t.operator,document.getElementById("messageNum").value=t.messageNum,document.getElementById("eventName").value=t.eventName;const n=document.getElementById("updateButton");n&&(n.style.display="inline-block");const o=document.getElementById("cancelEditButton");o&&(o.style.display="inline-block");const a=document.getElementById("changeDistanceButton");a&&(a.style.display="none"),console.log("Editing entry:",t)}catch(e){console.error("Error editing entry:",e),alert("Error editing entry: "+e.message)}}async function updateEntry(e){try{const t=entries[editingIndex];if(!t)return void console.error("Entry not found for update");t.action=e,t.time=document.getElementById("time").value,t.day=document.getElementById("yesterday").checked?"Yesterday":"Today",t.station=document.getElementById("aidStation").value,t.comment=safeString(document.getElementById("comment").value),t.eta=safeString(document.getElementById("eta").value),t.operator=safeString(document.getElementById("operatorName").value.trim()),t.messageNum=document.getElementById("messageNum").value,t.eventName=document.getElementById("eventName").value,t.date=(new Date).toLocaleDateString("en-US",{timeZone:"America/Los_Angeles"});if(await isOnline()){const e={bib:t.bib_number,status:[safeString(t.action),safeString(t.time),safeString(t.day),safeString(t.station),safeString(t.comment),safeString(t.eta),safeString(t.operator),safeString(t.eventName),safeString(t.messageNum),safeString(t.date)].join(" | "),first_name:t.first_name,last_name:t.last_name,age:t.age,gender:t.gender,distance:t.distance,previous_distance:t.previous_distance};console.log("POST payload for update:",e);const n=await fetch("submit_bib.1.3.3.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),o=await n.json();o.success?(console.log("Entry updated:",e),showAlerts&&alert("Entry updated successfully!"),await loadData()):(console.error("Failed to update entry:",o.error),showAlerts&&alert("Failed to update entry: "+o.error+". Changes saved locally."),saveData(!1))}else showAlerts&&alert("No internet connection. Changes saved locally."),saveData(!1);editingIndex=null,clearForm(),sortEntries(),filterBibLog()}catch(e){console.error("Error updating entry:",e),showAlerts&&alert("Error updating entry: "+e.message+". Changes saved locally."),saveData(!1)}finally{const e=document.getElementById("updateButton");e&&(e.style.display="none");const t=document.getElementById("cancelEditButton");t&&(t.style.display="none");const n=document.getElementById("changeDistanceButton");n&&(n.style.display="inline-block"),isSubmitting=!1}}async function addEntry(e){try{if(isSubmitting)return;isSubmitting=!0;let t=document.getElementById("bibNumber")?.value.trim()||("GENERAL"===e?"N/A":"");if(!t&&"GENERAL"!==e)return void(showAlerts&&alert("Please enter a Bib Number."));const n=t.split(",").map(e=>e.trim()).filter(e=>e);if(n.length>1&&"GENERAL"===e)return void(showAlerts&&alert("Multiple bibs not supported for GENERAL comments."));if(n.length>1&&null!==editingIndex)return void(showAlerts&&alert("Multiple bibs not supported while editing."));const o="GENERAL"===e?"generalComment":"comment",a=safeString(document.getElementById(o)?.value.trim()||""),r=checkSpelling(a);if(r&&showAlerts&&!confirm(r))return;const s=document.getElementById("time")?.value||"",i=document.getElementById("yesterday")?.checked?"Yesterday":"Today",l=document.getElementById("aidStation")?.value||"",c=safeString(document.getElementById("eta")?.value||"N/A"),d=safeString(document.getElementById("operatorName")?.value.trim()||""),m=document.getElementById("eventName")?.value||"Ray Miller 50-50",g=document.getElementById("messageNum")?.value||"1",u=(new Date).toLocaleDateString("en-US",{timeZone:"America/Los_Angeles"});for(const t of n){let n=bibList.find(e=>String(e.bib)===String(t))||{};const o={eventName:m,bib_number:t,action:"DNF"===e?"DNF":e,time:s,day:i,station:l,comment:a,eta:c,operator:d,date:u,messageNum:g,first_name:n.firstName||"N/A",last_name:n.lastName||"N/A",age:n.age||"N/A",gender:n.gender||"N/A",distance:n.distance||"N/A",previous_distance:n.previousDistance||"N/A"};entries.unshift(o);if(await isOnline()){const e={bib:o.bib_number,status:[safeString(o.action),safeString(o.time),safeString(o.day),safeString(o.station),safeString(o.comment),safeString(o.eta),safeString(o.operator),safeString(o.eventName),safeString(o.messageNum),safeString(o.date)].join(" | "),first_name:o.first_name,last_name:o.last_name,age:o.age,gender:o.gender,distance:o.distance,previous_distance:o.previous_distance};console.log("POST payload for add:",e);const t=await fetch("submit_bib.1.3.3.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),n=await t.json();n.success?(console.log("Entry added:",e),showAlerts&&alert("Entry added successfully!"),await loadData()):(console.error("Failed to add entry:",n.error),showAlerts&&alert("Failed to add entry: "+n.error+". Saved locally and queued."),offlineQueue.push(o),saveData(!1))}else showAlerts&&alert("No internet connection. Entry saved locally and queued."),offlineQueue.push(o),saveData(!1)}clearForm(),sortEntries(),filterBibLog();const b=document.getElementById("entryCount");b&&(b.textContent=entries.length)}catch(e){console.error("Error adding entry:",e),showAlerts&&alert("Error adding entry: "+e.message)}finally{isSubmitting=!1}}function toggleBibLog(){const e=document.getElementById("bibLogTable"),t=document.querySelector(".bib-log-wrapper");if(!e||!t)return console.error("Bib Log table or wrapper not found"),void setTimeout(toggleBibLog,100);const n="none"===e.style.display||""===e.style.display;e.style.display="table",n?setTimeout(()=>{filterBibLog(),t.scrollTop=0,console.log("Bib Log shown and scrolled to TOP")},10):console.log("Bib Log hidden")}function toggleMessageLog(){const e=document.getElementById("messageLogTable");if(e){const t=e.style.display;console.log("Attempting to toggle Message Log"),console.log("Current display:",t),e.style.display="none"===t?"table":"none",console.log("Message Log toggled to:",e.style.display),"table"===e.style.display&&setTimeout(updateMessageLogTable,0)}else console.error("Message Log table not found in DOM"),setTimeout(toggleMessageLog,100)}function exportCSV(){const e=[...entries].sort((e,t)=>new Date(t.timestamp||t.date)-new Date(e.timestamp||e.date)),t=["Bib #,Action,Time,Day,Station,Comment,ETA,Operator,Date,Event,First Name,Last Name,Age,Gender,Distance,Previous Distance",...e.map(e=>[`"${e.bib_number}"`,`"${e.action}"`,`"${e.time}"`,`"${e.day}"`,`"${e.station}"`,`"${e.comment}"`,`"${e.eta}"`,`"${e.operator}"`,`"${e.date}"`,`"${e.eventName}"`,`"${e.first_name}"`,`"${e.last_name}"`,`"${e.age}"`,`"${e.gender}"`,`"${e.distance}"`,`"${e.previous_distance}"`].join(","))].join("\n"),n=new Blob([t],{type:"text/csv"}),o=window.URL.createObjectURL(n),a=document.createElement("a");a.href=o,a.download=`bib_log_${(new Date).toISOString().replace(/[:.]/g,"-")}.csv`,a.click(),window.URL.revokeObjectURL(o),console.log("CSV exported, entries:",e.length)}function exportBibWinlinkTxt_v2(){const e=TVEMC_BatchCore.createBibBatchForExport("winlink");if(!e||!e.records||0===e.records.length)return void alert("No new bib entries to export for Winlink.");const t=[`MSG:${String(e.message_number||0).padStart(3,"0")} ${e.event_id||"EVENT"} ${e.aid_station_name||"STATION"} OP:${e.operator||"OPERATOR"} ${e.timestamp_local||""} BIB EXPORT`,["Bib #","Action","Time","Day","Station","Comment","ETA","Operator","Date","Event","First Name","Last Name","Age","Gender","Distance","Previous Distance"].join(","),...e.records.map(e=>[e.bib_number??"",e.action??"",e.time??"",e.day??"",e.station??"",e.comment??"",e.eta??"",e.operator??"",e.date??"",e.eventName??"",e.first_name??"",e.last_name??"",e.age??"",e.gender??"",e.distance??"",e.previous_distance??""].map(e=>`"${String(e).replace(/"/g,'""')}"`).join(","))].join("\n");downloadFile(TVEMC_BatchCore.filenameForBatch(e,"txt"),t,"text/plain"),alert(`BIB Winlink TXT Exported\nMessage #${e.message_number}`)}function updateMessageLogTable(){try{console.log("Updating Message Log table, entries:",messageLog);const e=document.querySelector("#messageLogTable tbody");if(!e)return void console.error("Message log table body not found");e.innerHTML="",messageLog.forEach((t,n)=>{const o=document.createElement("tr");o.innerHTML=`\n                <td>${t.messageNum}</td>\n                <td>${t.action}</td>\n                <td>${t.timestamp}</td>\n                <td><button class="edit-button" onclick="showMessageDetails(${n})">Show Entries</button></td>\n            `,e.insertBefore(o,e.firstChild)}),console.log("Message Log table updated, rows:",e.children.length)}catch(e){console.error("Error updating Message Log table:",e),alert("Error updating Message Log table: "+e.message)}}function showMessageDetails(e){try{const t=messageLog[e];let n=`Message #${t.messageNum} (${t.action}, ${t.timestamp})\n\n`;n+="Bib #\tAction\tTime\tDay\tStation\tComment\tETA\tOperator\tEvent\tFirst Name\tLast Name\tAge\tGender\tDistance\tPrevious Distance\n",t.entries.forEach(e=>{const t=bibList.find(t=>String(t.bib)===String(e.bib_number))||{firstName:e.first_name||"N/A",lastName:e.last_name||"N/A",age:e.age||"N/A",gender:e.gender||"N/A",distance:e.distance||"N/A",previousDistance:e.previous_distance||"N/A"};n+=`${e.bib_number||"N/A"}\t${"DROP"===e.action?"DNF":e.action}\t${e.time||"N/A"}\t${e.day||"N/A"}\t${e.station||"N/A"}\t${e.comment||"N/A"}\t${e.eta||"N/A"}\t${e.operator||"N/A"}\t${e.eventName||"N/A"}\t${t.firstName||"N/A"}\t${t.lastName||"N/A"}\t${t.age||"N/A"}\t${t.gender||"N/A"}\t${t.distance||"N/A"}\t${t.previousDistance||"N/A"}\n`}),console.log("Showing details for Message #",t.messageNum),alert(n)}catch(e){console.error("Error showing message details:",e),alert("Error showing message details: "+e.message)}}function clearLog(){try{if(!confirm("Are you sure you want to clear all entries, message log, and bib list? This will reset the current session but preserve previously saved data for restoration with Load Data."))return void console.log("Clear canceled at first prompt");const e=prompt('Type "CLEAR" to confirm clearing all current data:');if(e&&"CLEAR"===e.toUpperCase()){entries=[],messageLog=[],bibList=[],offlineQueue=[];const e=document.querySelector("#bibTable tbody");e&&(e.innerHTML="");const t=document.querySelector("#messageLogTable tbody");t&&(t.innerHTML="");const n=document.querySelector("#bibInfoTable tbody");n&&(n.innerHTML="");const o=document.getElementById("bibInfoTable");o&&(o.style.display="none");const a=document.getElementById("entryCount");a&&(a.textContent=0);const r=document.getElementById("generalComment");r&&(r.value=""),console.log("Logs cleared after double confirmation"),alert("Logs cleared successfully! Use Load Data to restore previously saved data."),saveData(!1)}else console.log("Clear canceled at second prompt, input:",e),alert('Clear canceled: You must type "CLEAR" to confirm.')}catch(e){console.error("Error clearing log:",e),alert("Error clearing log: "+e.message)}}function clearGeneralMessages(){if("CLEAR123"!==prompt("Enter authorization code to CLEAR ALL GENERAL MESSAGES:"))return void alert("Incorrect code. Access denied.");if(!confirm("Clear ALL general messages? This cannot be undone."))return;const e=document.getElementById("btnClearGeneralMessages"),t=e.innerHTML;e.disabled=!0,e.innerHTML="Clearing...",fetch("submit_general_comment.php",{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"action=clear_general_messages"}).then(e=>e.json()).then(e=>{e.success?(alert("All general messages have been cleared."),loadGeneralComments()):alert("Error: "+(e.error||"Failed to clear messages."))}).catch(e=>{console.error("Fetch error:",e),alert("Network error. Check console (F12).")}).finally(()=>{e.disabled=!1,e.innerHTML=t})}function importCSV(){try{if(!window.FileReader)return void alert("FileReader API not supported on this device. Try a different browser or device.");const e=document.createElement("input");e.type="file",e.accept=".csv,.xlsx",e.onchange=async function(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=async function(e){const t=e.target.result,n=XLSX.read(t,{type:"binary"}),o=n.Sheets[n.SheetNames[0]],a=XLSX.utils.sheet_to_json(o,{header:1}).slice(1);let r=0;const s=[],i=document.getElementById("messageNum")?.value,l=await isOnline();for(const e of a)if(e[0]&&e[1]&&e[4]&&e[7]){const t="DROP"===e[1]?"DNF":e[1],n={bib_number:String(e[0]).trim(),action:t,time:e[2]||"N/A",day:e[3]||"N/A",station:e[4],comment:e[5]||"",eta:e[6]||"N/A",operator:e[7].replace(/[.,]/g,"").trim(),eventName:e[8]||"Ray Miller 50-50",messageNum:i,date:e[9]||(new Date).toLocaleDateString("en-US",{timeZone:"America/Los_Angeles"}),first_name:e[10]||"",last_name:e[11]||"",age:parseInt(e[12])||"N/A",gender:e[13]||"N/A",distance:e[14]||"N/A",previous_distance:e[15]||"N/A"},o=entries.find(e=>String(e.bib_number)===String(n.bib_number)&&e.action===n.action&&e.time===n.time&&e.day===n.day&&e.station===n.station);if(o)continue;if(l){const e={bib:n.bib_number,status:[n.action,n.time,n.day,n.station,n.comment,n.eta,n.operator,n.eventName,n.messageNum,n.date].filter(Boolean).join(" | "),first_name:n.first_name,last_name:n.last_name,age:n.age,gender:n.gender,distance:n.distance,previous_distance:n.previous_distance};console.log("POST payload for import:",e);const t=await fetch("submit_bib.1.3.3.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);const o=await t.json();if(!o.success)throw new Error(o.error||"Import failed");s.unshift(n),r++}else offlineQueue.push(n),s.push(n)}s.forEach(e=>entries.unshift(e));const c=JSON.parse(localStorage.getItem("bibData")||"{}");c.entries=entries,c.offlineQueue=offlineQueue,localStorage.setItem("bibData",JSON.stringify(c)),entries=c.entries,offlineQueue=c.offlineQueue,sortEntries(),filterBibLog();const d=document.getElementById("entryCount");d&&(d.textContent=entries.length),alert(`Imported ${r} entries successfully! ${s.length-r} entries queued for sync.`),await loadData()},n.readAsBinaryString(t)},e.click()}catch(e){console.error("Error importing CSV:",e),alert("Error importing CSV: "+e.message)}}function resetToNewest(){try{bibSortDirection=Array(15).fill(1),messageSortDirection=Array(3).fill(1),currentSortColumn=null,currentSortDirection=1,sortEntries(),filterBibLog(),console.log("Reset to newest-first order")}catch(e){console.error("Error resetting to newest:",e),alert("Error resetting to newest: "+e.message)}}async function syncOfflineEntries(){try{if(!await isOnline())return showAlerts&&alert("No internet connection. Cannot sync offline entries yet."),void console.log("Sync attempted while offline");if(0===offlineQueue.length)return showAlerts&&alert("No offline entries to sync."),void console.log("No offline entries to sync");let e=0;const t=[];for(let n=offlineQueue.length-1;n>=0;n--){const o=offlineQueue[n],a={bib:o.bib_number,status:[safeString(o.action),safeString(o.time),safeString(o.day),safeString(o.station),safeString(o.comment),safeString(o.eta),safeString(o.operator),safeString(o.eventName),safeString(o.messageNum),safeString(o.date)].join(" | "),first_name:o.first_name,last_name:o.last_name,age:o.age,gender:o.gender,distance:o.distance,previous_distance:o.previous_distance};console.log("Syncing offline entry:",a);const r=await fetch("submit_bib.1.3.3.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),s=await r.json();if(s.success){entries.find(e=>e.bib_number===o.bib_number&&e.action===o.action&&e.time===o.time&&e.day===o.day&&e.station===o.station)||entries.unshift(o),offlineQueue.splice(n,1),e++}else console.error("Failed to sync entry:",s.error),"Bib required"===s.error?offlineQueue.splice(n,1):t.push(o)}saveData(!1),sortEntries(),filterBibLog();const n=document.getElementById("entryCount");n&&(n.textContent=entries.length),e>0?showAlerts&&alert(`Synced ${e} entries successfully! ${t.length} failed and remain queued.`):showAlerts&&alert("No entries were synced. Check console for errors."),console.log("Sync complete. Remaining in queue:",offlineQueue.length)}catch(e){console.error("Error during sync:",e),showAlerts&&alert("Error during sync: "+e.message+". Some entries may remain queued.")}}window.showHqMessageAtStation=function(e){const t=document.getElementById("stationInbox"),n=document.getElementById("stationInboxBody");document.getElementById("stationInboxTitle");if(!t||!n)return;t.style.display="block","No messages from HQ yet."===n.textContent.trim()&&(n.textContent="");let o="",a="",r="",s="",i=null;"string"==typeof e?o=e:e&&"object"==typeof e&&(o=e.text||"",a=e.channel||"",r=e.created_at||"",s=e.operator||"",i=e.id||null);const l=r||(new Date).toLocaleTimeString(),c=document.createElement("div");c.style.borderBottom="1px solid #555",c.style.padding="4px 0",c.style.display="flex",c.style.alignItems="center",c.style.gap="8px";const d=document.createElement("div");d.style.flex="1",d.textContent=`[${l}] ${o}`,a&&(d.textContent+=` (via ${a.toUpperCase()})`),s&&(d.textContent+=` – ${s}`);const m=document.createElement("label");m.style.fontSize="12px",m.style.whiteSpace="nowrap";const g=document.createElement("input");g.type="checkbox",g.style.marginRight="4px",m.appendChild(g),m.appendChild(document.createTextNode("Received")),g.addEventListener("change",function(){g.checked&&(stopHqInboxFlash(),i&&sendHqAckToServer(i))}),c.appendChild(d),c.appendChild(m),n.firstChild?n.insertBefore(c,n.firstChild):n.appendChild(c),startHqInboxFlash()},window.addEventListener("load",function(){const e=document.getElementById("stationInboxBody");e&&e.addEventListener("scroll",function(){stopHqInboxFlash()})}),document.addEventListener("DOMContentLoaded",()=>{try{console.log("DOM fully loaded");["operatorName","sendTo","aidStation"].forEach(e=>{const t=document.getElementById(e);t&&(t.addEventListener("input",saveFormState),t.addEventListener("change",saveFormState),console.log(`Added saveFormState listener for ${e}`))});["eventName","aidStation","messageNum"].forEach(e=>{const t=document.getElementById(e);t&&(t.addEventListener("input",updateSubject),t.addEventListener("change",updateSubject),console.log(`Added updateSubject listener for ${e}`))});const e=document.getElementById("fastMode");e&&(e.addEventListener("change",function(){try{const e=document.getElementById("time"),t=document.getElementById("yesterday");this.checked?(e&&(e.tabIndex=-1),t&&(t.tabIndex=-1),setCurrentTime()):(e&&(e.tabIndex=10),t&&(t.tabIndex=11)),console.log("Fast Mode toggled:",this.checked)}catch(e){console.error("Error toggling Fast Mode:",e),showAlerts&&alert("Error toggling Fast Mode: "+e.message)}}),console.log("Added fastMode listener"));const t=document.getElementById("highContrast");t&&(t.addEventListener("change",function(){try{document.body.classList.toggle("high-contrast",this.checked),console.log("High Contrast Mode:",this.checked)}catch(e){console.error("Error toggling High Contrast:",e),showAlerts&&alert("Error toggling High Contrast: "+e.message)}}),console.log("Added highContrast listener"));document.querySelectorAll("#raceForm .in-button, #raceForm .out-button, #raceForm .dnf-button, #raceForm .note-button, #raceForm .add-general-comment-button").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const n=e.textContent.trim();if("Add General Comment"===n)return addGeneralComment(),void console.log("Action button clicked: Add General Comment (routed to addGeneralComment)");null!==editingIndex?updateEntry(n):addEntry(n),console.log(`Action button clicked: ${n}`)})}),console.log("Added action button listeners");const n=document.getElementById("logSearch");n&&(n.addEventListener("input",filterBibLog),console.log("Added search listener")),loadFormState(),setCurrentTime(),updateSubject(),loadData();const o=document.getElementById("showAlerts");o&&(o.checked=showAlerts,o.addEventListener("change",function(){showAlerts=this.checked,localStorage.setItem("showAlerts",showAlerts)}))}catch(e){console.error("Error initializing page:",e),showAlerts&&alert("Error initializing page: "+e.message)}});let generalComments=[];async function addGeneralComment(){if(window.__addingGeneralComment)return void console.log("Duplicate general comment prevented");window.__addingGeneralComment=!0,setTimeout(()=>{window.__addingGeneralComment=!1},1500);const e=document.getElementById("generalComment"),t=e.value.trim();if(!t)return void(showAlerts&&alert("Please enter a general comment."));const n=document.getElementById("aidStation").value||"",o=document.getElementById("operatorName").value.trim()||"Unknown",a=document.getElementById("eventName").value||"Ray Miller 50-50";a!==localStorage.getItem("lastEvent")&&(localStorage.setItem("msgCounter",0),localStorage.setItem("lastEvent",a));const r=parseInt(localStorage.getItem("msgCounter")||"0",10)+1;localStorage.setItem("msgCounter",r);const s=r,i={aidStation:n,comment:t,operator:o,eventName:a,messageNum:s,timestamp:(new Date).toLocaleString("en-US",{timeZone:"America/Los_Angeles"})};generalComments.unshift(i);if(await isOnline())try{const e=await fetch("submit_general_comment.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({aidStation:n,comment:t,operator:o,eventName:a,messageNum:s})}),r=await e.json();if(!r.success)throw new Error(r.error)}catch(e){offlineQueue.push({type:"GENERAL",...i}),showAlerts&&alert("Offline. General comment queued.")}else offlineQueue.push({type:"GENERAL",...i}),showAlerts&&alert("Offline. General comment saved locally.");e.value="",updateGeneralMessageLog(),saveData(!1)}function updateGeneralMessageLog(){const e=document.querySelector("#generalMessageLogTable tbody"),t=document.querySelector("#generalMessageLogTable thead");if(!e||!t)return;const n=t.querySelector("tr");n.innerHTML="",["Aid Station","Msg #","Comment","Operator","Time"].forEach(e=>{const t=document.createElement("th");t.textContent=e,n.appendChild(t)}),e.innerHTML="",generalComments.forEach(t=>{const n=document.createElement("tr");n.innerHTML=`\n      <td>${t.aidStation||""}</td>\n      <td>${t.messageNum}</td>\n      <td>${t.comment}</td>\n      <td>${t.operator}</td>\n      <td>${t.timestamp}</td>\n    `,e.appendChild(n)})}function convertUTCToCustomTimeZone(e,t){const n=new Date(e);return new Date(n.getTime()+36e5*t).toLocaleString()}async function loadGeneralComments(){try{const e=await fetch("load_general_comments.php");if(!e.ok)throw new Error("Failed to load data");const t=await e.json();generalComments=Array.isArray(t)?t.map(e=>{const t=convertUTCToCustomTimeZone(e.timestamp,-8);return{aidStation:e.aid_station,comment:e.comment,operator:e.operator,eventName:e.event_name,messageNum:e.message_num,timestamp:t}}):[]}catch(e){const t=JSON.parse(localStorage.getItem("bibData")||"{}");generalComments=t.generalComments||[]}updateGeneralMessageLog()}function toggleGeneralMessageLog(){const e=document.getElementById("generalMessageLogTable");e&&(e.style.display="none"===e.style.display?"table":"none","table"===e.style.display&&updateGeneralMessageLog())}function incrementMessageNumber(){const e=parseInt(localStorage.getItem("msgCounter")||"0",10)+1;return localStorage.setItem("msgCounter",e),e}function generateCSVContent(){return["Aid Station,Msg #,Comment,Operator,Time",...generalComments.map(e=>[`"${e.aidStation||""}"`,`"${e.messageNum}"`,`"${(e.comment||"").replace(/"/g,'""')}"`,`"${e.operator||""}"`,`"${e.timestamp||""}"`].join(","))].join("\n")}function generateWinlinkContent(){return["Aid Station\tMsg #\tComment\tOperator\tTime",...generalComments.map(e=>[`${e.aidStation||""}`,`${e.messageNum}`,`${e.comment||""}`,`${e.operator||""}`,`${e.timestamp||""}`].join("\t"))].join("\n")}function exportGeneralCSV(){const e=incrementMessageNumber(),t=generateCSVContent(),n=`${(new Date).toISOString().slice(0,19).replace(/[-T:]/g,"")}_AidStation_${e}.csv`,o=new Blob([t],{type:"text/csv"}),a=document.createElement("a");a.href=URL.createObjectURL(o),a.download=n,a.click()}function exportGeneralWinlink(){const e=incrementMessageNumber(),t=generateWinlinkContent(),n=`${(new Date).toISOString().slice(0,19).replace(/[-T:]/g,"")}_AidStation_${e}.txt`,o=new Blob([t],{type:"text/plain"}),a=document.createElement("a");a.href=URL.createObjectURL(o),a.download=n,a.click()}function exportGeneralPDF(){const e=incrementMessageNumber(),{jsPDF:t}=window.jspdf,n=new t;n.text("General Message Log",10,10);let o=20;generalComments.forEach(e=>{n.text(`Aid Station: ${e.aidStation||""}`,10,o),o+=10,n.text(`Msg #: ${e.messageNum}`,10,o),o+=10,n.text(`Comment: ${e.comment||""}`,10,o),o+=10,n.text(`Operator: ${e.operator||""}`,10,o),o+=10,n.text(`Time: ${e.timestamp||""}`,10,o),o+=10});const a=`${(new Date).toISOString().slice(0,19).replace(/[-T:]/g,"")}_AidStation_${e}.pdf`;n.save(a)}function exportGeneralCSV(){if(0===generalComments.length)return alert("No general messages.");downloadFile(["Aid Station,Msg #,Comment,Operator,Time",...generalComments.map(e=>`"${e.aidStation||""}","${e.messageNum}","${(e.comment||"").replace(/"/g,'""')}","${e.operator||""}","${e.timestamp||""}"`)].join("\n"),`GeneralMsg_${(new Date).toISOString().slice(0,10)}.csv`,"text/csv")}function exportGeneralPDF(){if(0===generalComments.length)return alert("No general messages.");const{jsPDF:e}=window.jspdf,t=new e;t.setFontSize(16),t.text("General Message Log",10,15),t.setFontSize(10);let n=30;generalComments.forEach((e,o)=>{n>270&&(t.addPage(),n=20),t.text(`[${e.messageNum}] ${e.aidStation||"N/A"}: ${e.comment||""}`,10,n),n+=8,t.text(`    — ${e.operator||""} @ ${e.timestamp||""}`,15,n),n+=10}),t.save(`GeneralMsg_${(new Date).toISOString().slice(0,10)}.pdf`)}function exportGeneralWinlink(){if(0===generalComments.length)return alert("No general messages.");downloadFile(generalComments.map(e=>`[Msg ${e.messageNum}] ${e.aidStation||"N/A"}: ${e.comment||""} —${e.operator||""} @${e.timestamp||""}`).join("\n"),`GeneralMsg_Winlink_${(new Date).toISOString().slice(0,10)}.txt`,"text/plain")}function downloadFile(e,t,n){const o=new Blob([e],{type:n}),a=URL.createObjectURL(o),r=document.createElement("a");r.href=a,r.download=t,r.click(),URL.revokeObjectURL(a)}function exportBibCSV_v2(){if(!window.TVEMC_BatchCore)return void alert("Message batch core missing.");const e=TVEMC_BatchCore.createBibBatchForExport("csv");if(!e)return void alert("No new bib entries to export.");const t=[["Bib #","Action","Time","Day","Station","Comment","ETA","Operator","Date","Event","First Name","Last Name","Age","Gender","Distance","Previous Distance"].join(","),...e.records.map(e=>[`"${e.bib_number}"`,`"${e.action}"`,`"${e.time}"`,`"${e.day}"`,`"${e.station}"`,`"${e.comment}"`,`"${e.eta}"`,`"${e.operator}"`,`"${e.date}"`,`"${e.eventName}"`,`"${e.first_name}"`,`"${e.last_name}"`,`"${e.age}"`,`"${e.gender}"`,`"${e.distance}"`,`"${e.previous_distance}"`].join(","))].join("\n"),n=TVEMC_BatchCore.filenameForBatch(e,"csv"),o=new Blob([t],{type:"text/csv"}),a=URL.createObjectURL(o),r=document.createElement("a");r.href=a,r.download=n,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a),alert(`BIB CSV Exported\nMessage #${e.message_number}`)}function exportBibWinlinkTxt_v2(){if(!window.TVEMC_BatchCore)return void alert("Message batch core missing.");const e=TVEMC_BatchCore.createBibBatchForExport("winlink");if(!e)return void alert("No new bib entries to export for Winlink.");const t=[`MSG:${String(e.message_number||0).padStart(3,"0")} ${e.event_id||"EVENT"} ${e.aid_station_name||"STATION"} OP:${e.operator||"OPERATOR"} ${e.timestamp_local||""} BIB EXPORT`,["Bib #","Action","Time","Day","Station","Comment","ETA","Operator","Date","Event","First Name","Last Name","Age","Gender","Distance","Previous Distance"].join(","),...e.records.map(e=>[e.bib_number,e.action,e.time,e.day,e.station,e.comment,e.eta,e.operator,e.date,e.eventName,e.first_name,e.last_name,e.age,e.gender,e.distance,e.previous_distance].map(e=>String(null==e?"":e)).join(","))].join("\n"),n=TVEMC_BatchCore.filenameForBatch(e,"txt"),o=new Blob([t],{type:"text/plain"}),a=URL.createObjectURL(o),r=document.createElement("a");r.href=a,r.download=n,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a),alert(`BIB Winlink TXT Exported\nMessage #${e.message_number}`)}setInterval(()=>{try{"function"==typeof loadData&&loadData(),"function"==typeof loadGeneralComments&&loadGeneralComments(),console.log("Auto-refresh fired")}catch(e){console.error("Auto-refresh error:",e)}},3e4);