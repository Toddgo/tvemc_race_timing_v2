<?php
// passes_load.php
header('Content-Type: application/json; charset=utf-8');
header('Cache-Control: no-store');

$config = include __DIR__ . '/config.race.php';
$conn = new mysqli($config['host'], $config['username'], $config['password'], $config['dbname']);
if ($conn->connect_error) { http_response_code(500); echo json_encode([]); exit; }
$conn->set_charset('utf8mb4');

$event_code = trim($_GET['event_code'] ?? 'AZM-300-2026-0004');   //    KH_SOB_2026_01
$limit = (int)($_GET['limit'] ?? 500);
if ($limit <= 0 || $limit > 5000) $limit = 500;

// resolve event_id
$st = $conn->prepare("SELECT event_id FROM events WHERE event_code=? LIMIT 1");
$st->bind_param("s", $event_code);
$st->execute();
$row = $st->get_result()->fetch_assoc();
$st->close();
if (!$row) { echo json_encode([]); exit; }
$event_id = (int)$row['event_id'];

// Newest first. Join by station_id (since passes currently stores station_id)
$sql = "
  SELECT
  p.pass_id,
  ? AS event_code,
  p.bib,
  p.distance_code,
  a.station_order,
  a.station_name,
  a.is_finish,
  p.pass_type,
  p.pass_ts,
  p.operator,
  p.note
  FROM passes p
  LEFT JOIN aid_stations a ON a.station_id = p.station_id
  WHERE p.event_id = ?
  ORDER BY p.pass_id DESC
  LIMIT ?
";

$stmt = $conn->prepare($sql);
$stmt->bind_param("sii", $event_code, $event_id, $limit);
$stmt->execute();
$res = $stmt->get_result();

$out = [];
while ($r = $res->fetch_assoc()) {
  // Create a station_code for exports/imports even if DB doesnâ€™t store it yet
    // Derive station_code from station_name (station_order is per-distance and NOT compatible with AS codes)
  $nameU = strtoupper(trim($r['station_name'] ?? ''));

  if (!empty($r['is_finish'])) {
    $r['station_code'] = 'FINISH';
  } elseif ($nameU === '') {
    $r['station_code'] = '';
  } elseif (strpos($nameU, 'CORRAL CANYON #1') !== false) {
    $r['station_code'] = 'AS1';
  } elseif (strpos($nameU, 'KANAN ROAD #1') !== false) {
    $r['station_code'] = 'AS2';
  } elseif (strpos($nameU, 'TURNAROUND SPOT (30K NO AID)') !== false) {
  $r['station_code'] = 'T30K';
  } elseif (strpos($nameU, 'ZUMA EDISON RIDGE MTWY #1') !== false) {
    $r['station_code'] = 'AS4';
  } elseif (strpos($nameU, 'BONSALL') !== false) {
    $r['station_code'] = 'AS5';
  } elseif (strpos($nameU, 'ZUMA EDISON RIDGE MTWY #2') !== false) {
    $r['station_code'] = 'AS6';
  } elseif (strpos($nameU, 'KANAN ROAD #2') !== false) {
    $r['station_code'] = 'AS7';
  } elseif (strpos($nameU, 'CORRAL CANYON #2') !== false) {
    $r['station_code'] = 'AS8';
  } elseif (strpos($nameU, 'BULLDOG') !== false) {
    $r['station_code'] = 'AS9';
  } elseif (strpos($nameU, 'CORRAL CANYON #3') !== false) {
    $r['station_code'] = 'AS10';
  } elseif (strpos($nameU, 'PIUMA') !== false || strpos($nameU, 'PUMA') !== false) {
    $r['station_code'] = 'AS11';
  } else {
    $r['station_code'] = '';
  }

  $out[] = $r;
}

$stmt->close();
$conn->close();

echo json_encode($out);
//echo json_encode($rows);
//exit;